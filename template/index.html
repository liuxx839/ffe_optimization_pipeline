<!DOCTYPE html>
<html>
<head>
    <title>åŒºåŸŸåˆ†é…ä¼˜åŒ–</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        /* åœ£è¯ä¸»é¢˜æ ·å¼ */
        :root {
            --christmas-red: #D42426;
            --christmas-green: #2F5233;
            --snow-white: #fff;
            --holly-green: #146B3A;
        }
        
        /* é›ªèŠ±åŠ¨ç”» */
        .snowflake {
            position: fixed;
            color: var(--snow-white);
            font-size: 1em;
            font-family: Arial;
            text-shadow: 0 0 1px #000;
            user-select: none;
            z-index: 1000;
            animation: fall 10s linear infinite;
        }
        
        @keyframes fall {
            0% { transform: translateY(-100vh) rotate(0deg); }
            100% { transform: translateY(100vh) rotate(360deg); }
        }

        /* åœ£è¯ä¸»é¢˜å¼€å…³ */
        .theme-switch {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
        }

        /* åœ£è¯ä¸»é¢˜æ ·å¼ */
        body.christmas-theme {
            background-color: #f8f9fa;
            background-image: linear-gradient(to bottom, rgba(255,255,255,0.9), rgba(255,255,255,0.9)),
                            url('data:image/svg+xml,...'); /* æ·»åŠ subtleçš„åœ£è¯å›¾æ¡ˆèƒŒæ™¯ */
        }

        .christmas-theme .card {
            border-color: var(--christmas-green);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .christmas-theme .card-header {
            background-color: var(--holly-green);
            color: var(--snow-white);
        }

        .christmas-theme .btn-primary {
            background-color: var(--christmas-red);
            border-color: var(--christmas-red);
        }

        .christmas-theme .btn-success {
            background-color: var(--christmas-green);
            border-color: var(--christmas-green);
        }

        /* é©¯é¹¿è¿›åº¦æ¡æ ·å¼ */
        .christmas-theme .progress {
            height: 60px;
            background: linear-gradient(to bottom, #87CEEB 0%, #87CEEB 60%, #fff 60%, #fff 100%);
            border-radius: 30px;
            position: relative;
            overflow: visible;
        }

        .christmas-theme .progress-bar {
            background: none;
            position: relative;
        }

        .christmas-theme .progress-bar::after {
            content: "ğŸ…";
            font-size: 40px;
            position: absolute;
            right: -20px;
            top: -5px;
            animation: bounce 0.5s infinite alternate;
        }

        .christmas-theme .progress::before {
            content: "ğŸ¦Œ";
            font-size: 40px;
            position: absolute;
            left: -30px;
            top: -5px;
            transform: scaleX(-1);
        }

        @keyframes bounce {
            from {
                transform: translateY(0px);
            }
            to {
                transform: translateY(-3px);
            }
        }

        /* è¿›åº¦æ¡è½¨é“è£…é¥° */
        .christmas-theme .progress::after {
            content: "";
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
            height: 2px;
            background: repeating-linear-gradient(
                to right,
                var(--christmas-red) 0px,
                var(--christmas-red) 10px,
                transparent 10px,
                transparent 20px
            );
            opacity: 0.5;
        }

        /* è¿›åº¦ç™¾åˆ†æ¯”æ ·å¼ */
        #progressPercentage {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            color: var(--christmas-red);
            font-weight: bold;
            font-size: 1.2em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            z-index: 1;
        }

        .container { max-width: 1200px; padding-top: 2rem; }
        .preview-table { max-height: 400px; overflow-y: auto; }
        #status { margin-top: 1rem; }

        .countdown-container {
            position: fixed;
            left: 20px;
            bottom: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            border: 2px solid var(--christmas-red);
        }

        .christmas-theme .countdown-container {
            background: var(--holly-green);
            color: var(--snow-white);
        }

        .countdown-item {
            display: inline-block;
            margin: 0 10px;
            text-align: center;
        }

        .countdown-number {
            font-size: 24px;
            font-weight: bold;
            display: block;
        }

        .countdown-label {
            font-size: 12px;
            text-transform: uppercase;
        }

        .firework {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
        }

        .firework-particle {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            animation: explode 1.5s ease-out forwards;
            box-shadow: 0 0 10px 2px currentColor;
        }

        @keyframes explode {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            40% {
                opacity: 0.8;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) scale(0.1);
                opacity: 0;
            }
        }
    </style>
</head>
<body class="christmas-theme">
    <!-- ä¸»é¢˜åˆ‡æ¢å¼€å…³ -->
    <div class="theme-switch form-check form-switch">
        <input class="form-check-input" type="checkbox" id="themeSwitch" checked>
        <label class="form-check-label" for="themeSwitch">ğŸ„ åœ£è¯æ¨¡å¼</label>
    </div>

    <div class="container">
        <h1 class="mb-4">ğŸ„ åŒºåŸŸåˆ†é…ä¼˜åŒ–å·¥å…· ğŸ…</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">æ•°æ®ä¸Šä¼ </div>
                    <div class="card-body">
                        <form id="uploadForm">
                            <div class="mb-3">
                                <label class="form-label">é€‰æ‹©Excelæ–‡ä»¶ï¼š</label>
                                <input type="file" class="form-control" name="file" accept=".xlsx,.xls" required>
                            </div>
                            <button type="submit" class="btn btn-primary">ä¸Šä¼ æ–‡ä»¶</button>
                        </form>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header" data-bs-toggle="collapse" data-bs-target="#firstRoundCollapse" style="cursor: pointer;">
                        ç¬¬ä¸€è½®ä¼˜åŒ–å‚æ•°è®¾ç½® <i class="float-end">â–¼</i>
                    </div>
                    <div id="firstRoundCollapse" class="collapse">
                        <div class="card-body">
                            <form id="optimizeForm">
                                <div class="mb-3">
                                    <label class="form-label">FTEä¸‹é™ï¼š</label>
                                    <input type="number" class="form-control" name="fte_lower" value="0.85" step="0.01">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">FTEä¸Šé™(deprecated)ï¼š</label>
                                    <input type="number" class="form-control" name="fte_upper" value="1.15" step="0.01">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">FTEæƒé‡ï¼š</label>
                                    <input type="number" class="form-control" name="lambda_fte" value="4.0" step="0.1">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">è·ç¦»æƒé‡ï¼š</label>
                                    <input type="number" class="form-control" name="lambda_dist" value="1.0" step="0.1">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">æ—¶é—´é™åˆ¶ï¼ˆç§’ï¼‰ï¼š</label>
                                    <input type="number" class="form-control" name="time_limit" value="30">
                                </div>
                                <button type="submit" class="btn btn-success">è¿è¡Œç¬¬ä¸€è½®ä¼˜åŒ–</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header" data-bs-toggle="collapse" data-bs-target="#secondRoundCollapse" style="cursor: pointer;">
                        ç¬¬äºŒè½®ä¼˜åŒ–å‚æ•°è®¾ç½® <i class="float-end">â–¼</i>
                    </div>
                    <div id="secondRoundCollapse" class="collapse">
                        <div class="card-body">
                            <form id="secondRoundForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">è·ç¦»é˜ˆå€¼(deprecated)ï¼š</label>
                                            <input type="number" class="form-control" name="distance_threshold" value="0.8" step="0.1">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">FTEæƒé‡ï¼š</label>
                                            <input type="number" class="form-control" name="fte_weight" value="8" step="0.1">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">ç”Ÿäº§åŠ›æƒé‡ï¼š</label>
                                            <input type="number" class="form-control" name="prod_weight" value="5" step="0.1">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">æ½œåŠ›æƒé‡ï¼š</label>
                                            <input type="number" class="form-control" name="poten_weight" value="1" step="0.1">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">æ—¶é—´é™åˆ¶ï¼ˆç§’ï¼‰ï¼š</label>
                                            <input type="number" class="form-control" name="time_limit_step2" value="5" >
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">å¢é•¿æƒé‡ï¼š</label>
                                            <input type="number" class="form-control" name="growth_weight" value="1" step="0.1">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">åŒºåŸŸæƒé‡ï¼š</label>
                                            <input type="number" class="form-control" name="terri_weight" value="50" step="0.1">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">ç›®æ ‡FTEï¼š</label>
                                            <input type="number" class="form-control" name="target_fte" value="1" step="0.1">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">å¢é•¿ç‡é˜ˆå€¼ï¼š</label>
                                            <input type="number" class="form-control" name="growth_rate_threshold" value="1.18" step="0.01">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">å¹³å‡åŒ»é™¢æ•°é‡ï¼š</label>
                                            <input type="number" class="form-control" name="hco_count_avg" value="43.87" step="0.01">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">å¹³å‡ç”Ÿäº§åŠ›ï¼š</label>
                                            <input type="number" class="form-control" name="avg_productivity" value="9.56" step="0.01">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">å¹³å‡æ½œåŠ›ï¼š</label>
                                            <input type="number" class="form-control" name="avg_potential" value="334.38" step="0.01">
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary" disabled>è¿è¡Œç¬¬äºŒè½®ä¼˜åŒ–</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header" data-bs-toggle="collapse" data-bs-target="#thirdRoundCollapse" style="cursor: pointer;">
                        ç¬¬ä¸‰è½®ä¼˜åŒ–å‚æ•°è®¾ç½® <i class="float-end">â–¼</i>
                    </div>
                    <div id="thirdRoundCollapse" class="collapse">
                        <div class="card-body">
                            <form id="thirdRoundForm">
                                <div class="mb-3">
                                    <label class="form-label">å»ºè®®åŒºåŸŸæ•°é‡ï¼š</label>
                                    <input type="number" class="form-control" name="n_territories_suggested" value="25" min="1" step="1">
                                </div>
                                <button type="submit" class="btn btn-success" disabled>è¿è¡Œç¬¬ä¸‰è½®ä¼˜åŒ–</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header" data-bs-toggle="collapse" data-bs-target="#finalDiagnosisCollapse" style="cursor: pointer;">
                        æœ€ç»ˆè¯Šæ–­ <i class="float-end">â–¼</i>
                    </div>
                    <div id="finalDiagnosisCollapse" class="collapse">
                        <div class="card-body">
                            <div id="finalDiagnosticWarning" class="alert alert-info" style="display: none;"></div>
                            <button id="runFinalDiagnosis" class="btn btn-primary" disabled>è¿è¡Œæœ€ç»ˆè¯Šæ–­</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">æ•°æ®é¢„è§ˆ</div>
                    <div class="card-body">
                        <div class="preview-table">
                            <table class="table" id="previewTable">
                                <thead>
                                    <tr><th>ç­‰å¾…æ•°æ®ä¸Šä¼ ...</th></tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">ä¼˜åŒ–è¿‡ç¨‹</div>
                    <div class="card-body">
                        <div id="progressContainer" style="display: none;">
                            <p>ä¼˜åŒ–è¿›åº¦ï¼š</p>
                            <div class="progress">
                                <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuemin="0" aria-valuemax="100">
                                    <span id="progressPercentage">0%</span>
                                </div>
                            </div>
                        </div>
                        <div id="finalStatus" class="alert mt-3" style="display: none;"></div>
                    </div>
                </div>
                
                <div id="status" class="alert" style="display: none;"></div>

                <div class="card mt-4">
                    <div class="card-header">ä¼˜åŒ–è¯Šæ–­</div>
                    <div class="card-body">
                        <div id="diagnosticWarning" class="alert alert-warning" style="display: none;"></div>
                        <div class="table-responsive">
                            <table class="table table-sm" id="overlapTable">
                                <thead>
                                    <tr>
                                        <th>åŒºåŸŸ1</th>
                                        <th>åŒºåŸŸ2</th>
                                        <th>é‡å é¢ç§¯</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        
                        <div id="fitnessHistoryTable" class="table-responsive mt-4">
                            <h5>ä¼˜åŒ–å†å²è®°å½•</h5>
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>æ¬¡æ•°</th>
                                        <th>æ€»åˆ†</th>
                                        <th>å·¥ä½œé‡å¾—åˆ†</th>
                                        <th>å·¥ä½œé‡æƒ©ç½š</th>
                                        <th>å·¥ä½œé‡è¾¾æ ‡ç‡</th>
                                        <th>ç”Ÿäº§åŠ›å¾—åˆ†</th>
                                        <th>åŒä½æƒ©ç½š</th>
                                        <th>ä½äº§èƒ½æƒ©ç½š</th>
                                        <th>æ½œåŠ›å¾—åˆ†</th>
                                        <th>åŠå¾„è·ç¦»å¾—åˆ†</th>
                                        <th>è¡Œç¨‹è·ç¦»å¾—åˆ†</th>
                                        <th>åŠå¾„æƒ©ç½š</th>
                                        <th>è¡Œç¨‹æƒ©ç½š</th>
                                        <th>åŸå¸‚æƒ©ç½š</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="14" class="text-center">æš‚æ— æ•°æ®</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="countdown-container">
        <div class="countdown-item">
            <span id="countdown-days" class="countdown-number">00</span>
            <span class="countdown-label">å¤©</span>
        </div>
        <div class="countdown-item">
            <span id="countdown-hours" class="countdown-number">00</span>
            <span class="countdown-label">æ—¶</span>
        </div>
        <div class="countdown-item">
            <span id="countdown-minutes" class="countdown-number">00</span>
            <span class="countdown-label">åˆ†</span>
        </div>
        <div class="countdown-item">
            <span id="countdown-seconds" class="countdown-number">00</span>
            <span class="countdown-label">ç§’</span>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            $('#uploadForm').on('submit', function(e) {
                e.preventDefault();
                var formData = new FormData(this);
                $.ajax({
                    url: '/upload',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        $('#status').removeClass().addClass('alert alert-success')
                            .text('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼').show();
                        $('button[type="submit"]').prop('disabled', false);
                        $('#secondRoundForm button[type="submit"]').prop('disabled', false);
                        $('#thirdRoundForm button[type="submit"]').prop('disabled', false);
                        loadPreview();
                        updateFileList();
                    },
                    error: function(xhr) {
                        $('#status').removeClass().addClass('alert alert-danger')
                            .text('ä¸Šä¼ å¤±è´¥ï¼š' + xhr.responseJSON.error).show();
                    }
                });
            });

            $('#optimizeForm').on('submit', function(e) {
                e.preventDefault();
                startProgress();
                var formData = new FormData(this);
                $.ajax({
                    url: '/optimize',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    xhrFields: {
                        responseType: 'blob'
                    },
                    success: function(blob, status, xhr) {
                        const filename = xhr.getResponseHeader('Content-Disposition')?.split('filename=')[1] || 'optimization_results_dbcluster.xlsx';
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        
                        $.get('/get_diagnostic', function(response) {
                            console.log('Complete diagnostic data:', response); // ç”¨äºè°ƒè¯•
                            
                            // å¤„ç†ç¬¬ä¸€æ­¥çš„è¯Šæ–­ä¿¡æ¯
                            if (response.diagnostic_info && response.diagnostic_info.warning_msg) {
                                $('#diagnosticWarning').text(response.diagnostic_info.warning_msg).show();
                            }
                            
                            // å¤„ç†æœ€ç»ˆè¯Šæ–­ä¿¡æ¯
                            if (response.final_diagnostic_info) {
                                // // æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
                                // if (response.final_diagnostic_info.warning) {
                                //     $('#finalDiagnosticWarning').text(response.final_diagnostic_info.warning).show();
                                // }
                                
                                // æ›´æ–°å†å²è®°å½•è¡¨æ ¼
                                if (response.final_diagnostic_info.history && response.final_diagnostic_info.history.length > 0) {
                                    var tbody = '';
                                    response.final_diagnostic_info.history.forEach(function(record) {
                                        tbody += `<tr>
                                            <td>${record['æ¬¡æ•°']}</td>
                                            <td>${parseFloat(record['æ€»åˆ†']).toFixed(3)}</td>
                                            <td>${parseFloat(record['å·¥ä½œé‡å¾—åˆ†']).toFixed(3)}</td>
                                            <td>${parseFloat(record['å·¥ä½œé‡æƒ©ç½š']).toFixed(3)}</td>
                                            <td>${parseFloat(record['å·¥ä½œé‡è¾¾æ ‡ç‡']).toFixed(3)}</td>
                                            <td>${parseFloat(record['ç”Ÿäº§åŠ›å¾—åˆ†']).toFixed(3)}</td>
                                            <td>${parseFloat(record['åŒä½æƒ©ç½š']).toFixed(3)}</td>
                                            <td>${parseFloat(record['ä½äº§èƒ½æƒ©ç½š']).toFixed(3)}</td>
                                            <td>${parseFloat(record['æ½œåŠ›å¾—åˆ†']).toFixed(3)}</td>
                                            <td>${parseFloat(record['åŠå¾„è·ç¦»å¾—åˆ†']).toFixed(3)}</td>
                                            <td>${parseFloat(record['è¡Œç¨‹è·ç¦»å¾—åˆ†']).toFixed(3)}</td>
                                            <td>${parseFloat(record['åŠå¾„æƒ©ç½š']).toFixed(3)}</td>
                                            <td>${parseFloat(record['è¡Œç¨‹æƒ©ç½š']).toFixed(3)}</td>
                                            <td>${parseFloat(record['åŸå¸‚æƒ©ç½š']).toFixed(3)}</td>
                                        </tr>`;
                                    });
                                    $('#fitnessHistoryTable tbody').html(tbody);
                                    $('#fitnessHistoryTable').show();
                                }
                            }
                        });
                        
                        $('#status').removeClass().addClass('alert alert-success')
                            .text('ç¬¬ä¸€è½®ä¼˜åŒ–å®Œæˆï¼ç»“æœå·²ä¸‹è½½ã€‚').show();
                        updateFileList();
                    },
                    error: function(xhr) {
                        $('#finalStatus').removeClass().addClass('alert alert-danger')
                            .text('ä¼˜åŒ–å¤±è´¥ï¼š' + xhr.responseJSON.error).show();
                    }
                });
            });

            $('#secondRoundForm').on('submit', function(e) {
                e.preventDefault();
                $('#status').removeClass().addClass('alert alert-info')
                    .text('æ­£åœ¨è¿›è¡Œç¬¬äºŒè½®ä¼˜åŒ–...').show();
                
                var formData = new FormData(this);
                
                $.ajax({
                    url: '/optimize_second_round',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    xhrFields: {
                        responseType: 'blob'
                    },
                    success: function(blob) {
                        var url = window.URL.createObjectURL(blob);
                        var a = document.createElement('a');
                        a.href = url;
                        a.download = 'second_round_exploration.xlsx';
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        $('#status').removeClass().addClass('alert alert-success')
                            .text('ç¬¬äºŒè½®ä¼˜åŒ–å®Œæˆï¼ç»“æœå·²ä¸‹è½½ã€‚').show();
                        updateFileList();
                    },
                    error: function(xhr) {
                        $('#status').removeClass().addClass('alert alert-danger')
                            .text('ç¬¬äºŒè½®ä¼˜åŒ–å¤±è´¥ï¼š' + (xhr.responseJSON ? xhr.responseJSON.error : 'æœªçŸ¥é”™è¯¯')).show();
                    }
                });
            });

            $('#thirdRoundForm').on('submit', function(e) {
                e.preventDefault();
                $('#status').removeClass().addClass('alert alert-info')
                    .text('æ­£åœ¨è¿›è¡Œç¬¬ä¸‰è½®ä¼˜åŒ–...').show();
                
                var formData = new FormData(this);
                var n_territories = formData.get('n_territories_suggested');
                
                $.ajax({
                    url: '/optimize_third_round',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    xhrFields: {
                        responseType: 'blob'
                    },
                    success: function(blob, status, xhr) {
                        const filename = xhr.getResponseHeader('Content-Disposition')?.split('filename=')[1] || 
                                       `final_optimization_n${n_territories}_gurobi_region_divided_for_plot.xlsx`;
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        $('#status').removeClass().addClass('alert alert-success')
                            .text('ç¬¬ä¸‰è½®ä¼˜åŒ–å®Œæˆï¼ç»“æœå·²ä¸‹è½½ã€‚').show();
                        updateFileList();
                        $('#runFinalDiagnosis').prop('disabled', false);
                    },
                    error: function(xhr) {
                        $('#status').removeClass().addClass('alert alert-danger')
                            .text('ç¬¬ä¸‰è½®ä¼˜åŒ–å¤±è´¥ï¼š' + (xhr.responseJSON ? xhr.responseJSON.error : 'æœªçŸ¥é”™è¯¯')).show();
                    }
                });
            });

            $('#runFinalDiagnosis').on('click', function(e) {
                e.preventDefault();
                $.ajax({
                    url: '/final_diagnosis',
                    type: 'POST',
                    xhrFields: {
                        responseType: 'blob'
                    },
                    success: function(blob, status, xhr) {
                        // ä¸‹è½½è¯Šæ–­æ–‡ä»¶
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'final_diagnosis.xlsx';
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        
                        // è·å–è¯Šæ–­ä¿¡æ¯å¹¶æ›´æ–°UI
                        $.get('/get_diagnostic', function(response) {
                            console.log('Complete diagnostic data:', response); // ç”¨äºè°ƒè¯•
                            
                            // å¤„ç†ç¬¬ä¸€æ­¥çš„è¯Šæ–­ä¿¡æ¯
                            if (response.diagnostic_info && response.diagnostic_info.warning_msg) {
                                $('#diagnosticWarning').text(response.diagnostic_info.warning_msg).show();
                            }
                            
                            // å¤„ç†æœ€ç»ˆè¯Šæ–­ä¿¡æ¯
                            if (response.final_diagnostic_info) {
                                // æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
                                if (response.final_diagnostic_info.warning) {
                                    $('#finalDiagnosticWarning').text(response.final_diagnostic_info.warning).show();
                                }
                                
                                // æ›´æ–°å†å²è®°å½•è¡¨æ ¼
                                if (response.final_diagnostic_info.history && response.final_diagnostic_info.history.length > 0) {
                                    var tbody = '';
                                    response.final_diagnostic_info.history.forEach(function(record) {
                                        tbody += `<tr>
                                            <td>${record['æ¬¡æ•°']}</td>
                                            <td>${parseFloat(record['æ€»åˆ†']).toFixed(3)}</td>
                                            <td>${parseFloat(record['å·¥ä½œé‡å¾—åˆ†']).toFixed(3)}</td>
                                            <td>${parseFloat(record['å·¥ä½œé‡æƒ©ç½š']).toFixed(3)}</td>
                                            <td>${parseFloat(record['å·¥ä½œé‡è¾¾æ ‡ç‡']).toFixed(3)}</td>
                                            <td>${parseFloat(record['ç”Ÿäº§åŠ›å¾—åˆ†']).toFixed(3)}</td>
                                            <td>${parseFloat(record['åŒä½æƒ©ç½š']).toFixed(3)}</td>
                                            <td>${parseFloat(record['ä½äº§èƒ½æƒ©ç½š']).toFixed(3)}</td>
                                            <td>${parseFloat(record['æ½œåŠ›å¾—åˆ†']).toFixed(3)}</td>
                                            <td>${parseFloat(record['åŠå¾„è·ç¦»å¾—åˆ†']).toFixed(3)}</td>
                                            <td>${parseFloat(record['è¡Œç¨‹è·ç¦»å¾—åˆ†']).toFixed(3)}</td>
                                            <td>${parseFloat(record['åŠå¾„æƒ©ç½š']).toFixed(3)}</td>
                                            <td>${parseFloat(record['è¡Œç¨‹æƒ©ç½š']).toFixed(3)}</td>
                                            <td>${parseFloat(record['åŸå¸‚æƒ©ç½š']).toFixed(3)}</td>
                                        </tr>`;
                                    });
                                    $('#fitnessHistoryTable tbody').html(tbody);
                                    $('#fitnessHistoryTable').show();
                                }
                            }
                        });
                    },
                    error: function(xhr) {
                        alert('è¯Šæ–­å¤±è´¥ï¼š' + (xhr.responseJSON ? xhr.responseJSON.error : 'æœªçŸ¥é”™è¯¯'));
                    }
                }, 1000); // ç­‰å¾…1ç§’åè·å–è¯Šæ–­ä¿¡æ¯
            });

            function startProgress() {
                $('#progressContainer').show();
                const eventSource = new EventSource('/progress');
                eventSource.onmessage = function(event) {
                    const progress = parseInt(event.data);
                    $('#progressPercentage').text(progress + '%');
                    $('#progressBar').css('width', progress + '%');
                    if (progress === 100) {
                        eventSource.close();
                        $('#finalStatus').removeClass().addClass('alert alert-success').text('ä¼˜åŒ–å®Œæˆï¼').show();
                    }
                };
                eventSource.onerror = function() {
                    eventSource.close();
                    $('#finalStatus').removeClass().addClass('alert alert-danger').text('ä¼˜åŒ–å¤±è´¥ï¼è¯·é‡è¯•ã€‚').show();
                };
            }

            function loadPreview() {
                $.get('/preview', function(response) {
                    var table = $('#previewTable');
                    var thead = '<tr>';
                    response.columns.forEach(function(col) {
                        thead += '<th>' + col + '</th>';
                    });
                    thead += '</tr>';
                    
                    var tbody = '';
                    response.data.forEach(function(row) {
                        tbody += '<tr>';
                        response.columns.forEach(function(col) {
                            tbody += '<td>' + row[col] + '</td>';
                        });
                        tbody += '</tr>';
                    });
                    
                    table.find('thead').html(thead);
                    table.find('tbody').html(tbody);
                });
            }

            function updateFileList() {
                $.get('/list_files', function(response) {
                    if (response.files) {
                        var tbody = '';
                        response.files.forEach(function(file) {
                            var size = (file.size / 1024).toFixed(2) + ' KB';
                            var date = new Date(file.modified * 1000).toLocaleString();
                            tbody += `
                                <tr>
                                    <td>${file.name}</td>
                                    <td>${size}</td>
                                    <td>${date}</td>
                                    <td>
                                        <a href="/download/${file.name}" class="btn btn-sm btn-primary">ä¸‹è½½</a>
                                    </td>
                                </tr>
                            `;
                        });
                        $('#fileListBody').html(tbody);
                    }
                });
            }

            updateFileList();

            // é›ªèŠ±æ•ˆæœ
            function createSnowflake() {
                const snowflake = document.createElement('div');
                snowflake.classList.add('snowflake');
                // åˆ›å»ºåœ£è¯ç›¸å…³emojiæ•°ç»„å¹¶éšæœºé€‰æ‹©ä¸€ä¸ª
                const christmasEmojis = ['â„', 'ğŸ„', 'ğŸ…', 'â›„', 'ğŸ', 'ğŸ¦Œ', 'ğŸ””', 'âœ¨'];
                snowflake.innerHTML = christmasEmojis[Math.floor(Math.random() * christmasEmojis.length)];
                snowflake.style.left = Math.random() * 100 + 'vw';
                snowflake.style.animationDuration = Math.random() * 3 + 7 + 's';
                snowflake.style.opacity = Math.random();
                document.body.appendChild(snowflake);

                setTimeout(() => {
                    snowflake.remove();
                }, 10000);
            }

            // æ·»åŠ ä¸€ä¸ªå˜é‡æ¥å­˜å‚¨å®šæ—¶å™¨ID
            let snowflakeInterval;

            // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
            $('#themeSwitch').change(function() {
                $('body').toggleClass('christmas-theme');
                if($(this).is(':checked')) {
                    // å¼€å¯é›ªèŠ±æ•ˆæœ
                    snowflakeInterval = setInterval(createSnowflake, 300);
                } else {
                    // æ¸…é™¤æ‰€æœ‰é›ªèŠ±å’Œå®šæ—¶å™¨
                    $('.snowflake').remove();
                    clearInterval(snowflakeInterval);
                }
            });

            // é»˜è®¤å¼€å¯é›ªèŠ±æ•ˆæœ
            snowflakeInterval = setInterval(createSnowflake, 300);

            function updateCountdown() {
                const targetDate = new Date('2025-01-01T00:00:00');
                const now = new Date();
                const diff = targetDate - now;

                if (diff > 0) {
                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                    $('#countdown-days').text(String(days).padStart(2, '0'));
                    $('#countdown-hours').text(String(hours).padStart(2, '0'));
                    $('#countdown-minutes').text(String(minutes).padStart(2, '0'));
                    $('#countdown-seconds').text(String(seconds).padStart(2, '0'));
                }
            }

            // æ¯ç§’æ›´æ–°å€’è®¡æ—¶
            setInterval(updateCountdown, 1000);
            updateCountdown(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡

            function createFirework() {
                // éšæœºé€‰æ‹©å±å¹•ä¸Šçš„å‘å°„ç‚¹
                const startX = Math.random() * window.innerWidth;
                const startY = window.innerHeight;
                
                // éšæœºé€‰æ‹©çˆ†ç‚¸ç‚¹ï¼ˆåœ¨å±å¹•ä¸ŠåŠéƒ¨åˆ†ï¼‰
                const explosionX = Math.random() * window.innerWidth;
                const explosionY = Math.random() * (window.innerHeight * 0.5);

                // åˆ›å»ºçƒŸèŠ±å®¹å™¨
                const firework = document.createElement('div');
                firework.className = 'firework';
                firework.style.left = startX + 'px';
                firework.style.top = startY + 'px';
                document.body.appendChild(firework);

                // çƒŸèŠ±ä¸Šå‡åŠ¨ç”»
                const riseAnimation = firework.animate([
                    { transform: `translate(0, 0)` },
                    { transform: `translate(${explosionX - startX}px, ${explosionY - startY}px)` }
                ], {
                    duration: 1000,
                    easing: 'ease-out'
                });

                // çƒŸèŠ±çˆ†ç‚¸
                riseAnimation.onfinish = () => {
                    firework.style.left = explosionX + 'px';
                    firework.style.top = explosionY + 'px';

                    // åˆ›å»ºçˆ†ç‚¸ç²’å­
                    const particleCount = 80; // å¢åŠ ç²’å­æ•°é‡
                    const colors = [
                        '#ff0000', '#ffd700', '#ff1493', '#00ff00', '#00ffff', 
                        '#ff4500', '#ff69b4', '#7fff00', '#1e90ff', '#ff00ff'
                    ];

                    for (let i = 0; i < particleCount; i++) {
                        const particle = document.createElement('div');
                        particle.className = 'firework-particle';
                        
                        // éšæœºè§’åº¦å’Œè·ç¦»
                        const angle = (Math.PI * 2 * i) / particleCount + (Math.random() * 0.5);
                        const velocity = 200 + Math.random() * 200;
                        const tx = Math.cos(angle) * velocity;
                        const ty = Math.sin(angle) * velocity;
                        
                        // éšæœºé¢œè‰²
                        const color = colors[Math.floor(Math.random() * colors.length)];
                        particle.style.backgroundColor = color;
                        particle.style.color = color; // ç”¨äºå‘å…‰æ•ˆæœ
                        
                        // è®¾ç½®è¿åŠ¨è½¨è¿¹
                        particle.style.setProperty('--tx', tx + 'px');
                        particle.style.setProperty('--ty', ty + 'px');
                        
                        firework.appendChild(particle);
                    }

                    // æ¸…ç†çƒŸèŠ±
                    setTimeout(() => {
                        firework.remove();
                    }, 1500);
                };
            }

            function startFireworks() {
                // åœ¨å±å¹•ä¸Šéšæœºä½ç½®å‘å°„å¤šä¸ªçƒŸèŠ±
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => {
                        createFirework();
                    }, i * 300); // æ¯éš”300mså‘å°„ä¸€ä¸ªçƒŸèŠ±
                }
            }

            // ç‚¹å‡»å€’è®¡æ—¶è§¦å‘çƒŸèŠ±
            $('.countdown-container').on('click', function() {
                // è¿ç»­å‘å°„3è½®çƒŸèŠ±
                for (let round = 0; round < 3; round++) {
                    setTimeout(() => {
                        startFireworks();
                    }, round * 1500);
                }
            });

            // æ·»åŠ é¼ æ ‡æ‚¬åœæ•ˆæœ
            $('.countdown-container').css('cursor', 'pointer').hover(
                function() {
                    $(this).css('transform', 'scale(1.05)');
                },
                function() {
                    $(this).css('transform', 'scale(1)');
                }
            );

            // æ·»åŠ è¿‡æ¸¡æ•ˆæœ
            $('.countdown-container').css('transition', 'transform 0.3s ease');
        });
    </script>
   
      <!-- Chatbot åµŒå…¥å¼€å§‹ -->
<script>
    // é…ç½® Chatbot
    window.difyChatbotConfig = {
      token: 'ntCt1l2Yz8UshrJ6'
    };
  </script>
  <script src="./embed.min.js" id="ntCt1l2Yz8UshrJ6" defer></script>
  <style>
    #dify-chatbot-bubble-button {
      background-color: #7A00E6 !important;
      width: 80px; /* è°ƒæ•´å›¾æ ‡çš„å®½åº¦ */
      height: 80px; /* è°ƒæ•´å›¾æ ‡çš„é«˜åº¦ */
      font-size: 80px; /* è°ƒæ•´å›¾æ ‡çš„å­—ä½“å¤§å° */
    }
    #dify-chatbot-bubble-window {
      width: 40rem !important;
      height: 60rem !important;
    }
  </style>
  <!-- Chatbot åµŒå…¥ç»“æŸ -->
  
</body>
</html>
